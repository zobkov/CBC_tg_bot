# Система записи на интервью

## Обзор системы

Система позволяет одобренным кандидатам записываться на интервью с менеджерами отделов. Включает:

1. **База данных временных слотов** - таблица `interview_timeslots`
2. **Статус одобрения пользователей** - колонка `approved` в таблице `users`
3. **Диалог записи на интервью** - интерфейс для выбора времени
4. **Система изменения записи** - возможность перенести интервью

## Структура базы данных

### Таблица `users`
- `approved` (INTEGER) - статус одобрения:
  - `0` - не одобрен
  - `1` - одобрен на позицию 1 (приоритет 1)
  - `2` - одобрен на позицию 2 (приоритет 2) 
  - `3` - одобрен на позицию 3 (приоритет 3)

### Таблица `interview_timeslots`
- `department_number` - номер отдела (1-7)
- `interview_date` - дата интервью
- `start_time` - время начала
- `is_available` - доступен ли слот (по умолчанию FALSE)
- `reserved_by` - ID пользователя, забронировавшего слот

## Маппинг отделов

```
1 - Отдел программы
2 - Творческий отдел
3 - Отдел партнёров
4 - Отдел SMM&PR
5 - Отдел дизайна
6 - Отдел логистики и ИТ
7 - Выставочный отдел
```

## Скрипты управления

### 1. Обновление статуса одобрения из CSV

```bash
python3 update_approved_status.py "approved_candidates.csv"
```

Формат CSV:
```
id,username,отдел,подотдел,вакансия,одобрен
257026813,zobko,Отдел SMM&PR,Медиа-шоу,Режиссер,Да
```

### 2. Загрузка временных слотов из CSV

```bash
# Для отдела логистики (6)
python3 populate_interview_timeslots.py logistics_timeslots.csv 6

# Для отдела SMM&PR (4)
python3 populate_interview_timeslots.py smm_timeslots.csv 4
```

Формат CSV временных слотов:
```
Время,4 октября,5 октября,6 октября
8:00,Нет,Нет,Нет
15:00,Да,Да,Да
```

### 3. Миграции

```bash
python3 run_applications_migrations.py
```

Выполнятся миграции:
- `012_add_approved_column.sql` - добавление колонки `approved`
- `013_create_interview_timeslots_table.sql` - создание таблицы слотов

## Логика работы диалога

### Доступ к диалогу
- Только пользователи с `approved > 0` могут видеть кнопку "Интервью" в главном меню
- Кнопка появляется автоматически при наличии одобрения

### Процесс записи
1. **Выбор дня** - показываются только дни с доступными слотами
2. **Выбор времени** - ScrollingGroup с доступными временами (2 колонки, 6 рядов)
3. **Подтверждение** - показ выбранной даты и времени
4. **Успешная запись** - уведомление о записи

### Изменение записи
1. Если у пользователя уже есть запись, показывается кнопка "Перенести интервью"
2. При выборе нового времени старая запись автоматически отменяется
3. Слот становится доступным для других пользователей

## Особенности реализации

### ScrollingGroup для временных слотов
- Ширина: 2 колонки
- Высота: 6 рядов  
- Автоматическая пагинация при большом количестве слотов

### Atomicity операций
- Бронирование и отмена происходят в транзакциях
- При рескедуле старая запись отменяется автоматически
- Проверка доступности слота перед бронированием

### Обработка ошибок
- Graceful degradation при ошибках БД
- Информативные сообщения пользователю
- Логирование ошибок для отладки

## Тестирование

```bash
python3 test_interview_system.py
```

Тестирует:
- Получение одобренного отдела
- Получение доступных дат
- Получение временных слотов
- Бронирование и отмену записи
- Рескедулинг

## Файловая структура

```
app/
├── bot/
│   ├── dialogs/interview/
│   │   ├── __init__.py
│   │   ├── dialogs.py      # Определение диалогов
│   │   ├── getters.py      # Функции получения данных
│   │   └── handlers.py     # Обработчики событий
│   └── states/
│       └── interview.py    # FSM состояния
├── infrastructure/database/dao/
│   └── interview.py        # DAO для работы с БД
migrations/
├── 012_add_approved_column.sql
└── 013_create_interview_timeslots_table.sql
```

## Расширение системы

### Добавление нового отдела
1. Обновить маппинг отделов в `InterviewDAO.get_user_approved_department()`
2. Создать CSV с временными слотами для отдела
3. Загрузить слоты: `python3 populate_interview_timeslots.py dept_timeslots.csv DEPT_NUMBER`

### Изменение временных слотов
1. Обновить CSV файл
2. Перезагрузить слоты для отдела
3. Система автоматически обновит доступность в интерфейсе