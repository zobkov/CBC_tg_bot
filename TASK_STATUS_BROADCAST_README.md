# Скрипт рассылки статуса заданий

## Описание

Скрипт `send_task_status_broadcast.py` предназначен для отправки персонализированных сообщений пользователям категории "accepted" со статусом отправки их заданий.

## Логика определения статуса

Для каждого пользователя и каждого из 3 заданий статус определяется следующим образом:

1. **"решение отправлено"** - если пользователь был принят для выполнения задания (в таблице `evaluated_applications` соответствующее поле `accepted_X = TRUE`) И он отправил решение для этого задания (в таблице `users` поле `task_X_submitted = TRUE`)

2. **"решение не отправлено"** - если пользователь был принят для выполнения задания (в таблице `evaluated_applications` соответствующее поле `accepted_X = TRUE`) И он НЕ отправил решение для этого задания (в таблице `users` поле `task_X_submitted = FALSE`)

3. **"–"** - если пользователь НЕ был принят для выполнения задания (в таблице `evaluated_applications` соответствующее поле `accepted_X = FALSE` или запись отсутствует)

## Использование

### Показать справку
```bash
python3 send_task_status_broadcast.py --help
```

### Посмотреть статистику
```bash
python3 send_task_status_broadcast.py stats
```

### Тестовая отправка (только тестовому пользователю ID: 257026813)
```bash
# Просмотреть что будет отправлено
python3 send_task_status_broadcast.py send --test --dry-run

# Отправить сообщение тестовому пользователю
python3 send_task_status_broadcast.py send --test
```

### Полная рассылка всем принятым пользователям
```bash
# Просмотреть что будет отправлено
python3 send_task_status_broadcast.py send --dry-run

# Отправить сообщения всем пользователям
python3 send_task_status_broadcast.py send
```

## Шаблон сообщения

Каждому пользователю отправляется персонализированное сообщение с его статусом:

```
До конца второго этапа отбора уже совсем ничего!

Твой статус:
Вакансия №1: {статус задания 1}
Вакансия №2: {статус задания 2}
Вакансия №3: {статус задания 3}

Обрати внимание! Чтобы мы проверили задание, надо обязательно завершить задание.
Ответы на частые вопросы можно найти тут

Если у вас есть любые проблемы и вопросы, не стесняйтесь писать нам:
Тех. поддержка: @zobko
По остальным вопросам и по заданиям: @cbc_assistant
```

## Безопасность

- Скрипт включает тестовый режим для отправки только одному пользователю
- Поддерживается dry-run режим для предварительного просмотра
- Скрипт запрашивает подтверждение перед массовой отправкой
- Включает rate limiting (0.05 сек между сообщениями)
- Логирует ошибки отправки

## Требования

- Python 3.8+
- Установленные зависимости из requirements.txt
- Настроенная база данных PostgreSQL
- Токен Telegram бота

## Лог

Скрипт выводит подробную информацию о процессе:
- Количество найденных пользователей
- Статистику по статусам заданий
- Количество отправленных сообщений
- Ошибки отправки