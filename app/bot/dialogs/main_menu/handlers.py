from aiogram.types import Message, CallbackQuery
from aiogram_dialog import DialogManager

from app.bot.states.first_stage import FirstStageSG
from app.bot.states.main_menu import MainMenuSG
from app.bot.states.tasks import TasksSG
from app.infrastructure.database.database.db import DB


async def on_current_stage_clicked(callback: CallbackQuery, button, dialog_manager: DialogManager):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É '–¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è'"""
    # –°–Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ç–∞–π–º–∞—É—Ç–∞
    await callback.answer()
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    db: DB = dialog_manager.middleware_data.get("db")
    event_from_user = dialog_manager.event.from_user
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–µ–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–≤—ã–π —ç—Ç–∞–ø
    if db:
        try:
            evaluation = await db.evaluated_applications.get_evaluation(user_id=event_from_user.id)
            
            if evaluation:
                # –ï—Å–ª–∏ –≤—Å–µ accepted_1, accepted_2, accepted_3 = False, –∑–Ω–∞—á–∏—Ç –Ω–µ –ø—Ä–æ—à–µ–ª
                is_first_stage_passed = evaluation.accepted_1 or evaluation.accepted_2 or evaluation.accepted_3
                
                if not is_first_stage_passed:
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏ –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∏–∫—É–¥–∞
                    await callback.message.answer("""–ú—ã –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏–ª–∏ –±–æ–ª–µ–µ 300 –∑–∞—è–≤–æ–∫. –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –±—ã–ª–∞ –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–π, –∏ –∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–∞ —ç—Ç–æ—Ç —Ä–∞–∑ —Ç–≤–æ–π –ø—É—Ç—å –≤ —Ä–∞–º–∫–∞—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç–±–æ—Ä–∞ –Ω–∞ —ç—Ç–æ–º –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è. –≠—Ç–æ –Ω–µ –ø—Ä–∏–≥–æ–≤–æ—Ä, —ç—Ç–æ ‚Äì —Ç–æ—á–∫–∞ —Ä–æ—Å—Ç–∞, –æ—Ç –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–Ω–æ (–∏ –Ω—É–∂–Ω–æ!) –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ. –ú—ã –±—É–¥–µ–º —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å —Ç–µ–±—è –Ω–∞ –¥—Ä—É–≥–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö –ö–ë–ö'26.

–ú—ã –≤–µ—Ä–∏–º –≤ —Ç–≤–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∏ —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã —Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞–ª —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å —Å–µ–±—è. –í —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞—è–≤–∫–∞—Ö –ø–æ–ø—Ä–æ–±—É–π –ø–æ–¥—Ä–æ–±–Ω–µ–µ –¥–µ–ª–∏—Ç—å—Å—è —Ç–µ–º, —á—Ç–æ –¥–ª—è —Ç–µ–±—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω–æ: –æ–ø—ã—Ç–æ–º, –º—ã—Å–ª—è–º–∏, –∏–¥–µ—è–º–∏, —Ç–µ–º, —á—Ç–æ —Ç–µ–±—è –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç. –ü–æ–∑–≤–æ–ª—å –Ω–∞–º —É–≤–∏–¥–µ—Ç—å –∑–∞ —Å—Ç—Ä–æ—á–∫–∞–º–∏ –∞–Ω–∫–µ—Ç—ã –∂–∏–≤–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞: —Ç–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä, —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –∞–º–±–∏—Ü–∏–∏.
–£–≤–µ—Ä–µ–Ω—ã, –≤–ø–µ—Ä–µ–¥–∏ –µ—â—ë –º–Ω–æ–≥–æ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π, –≥–¥–µ —Ç–≤–æ—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Å–º–æ–∂–µ—Ç –ø—Ä–æ—è–≤–∏—Ç—å—Å—è –≤ –ø–æ–ª–Ω–æ–π –º–µ—Ä–µ.

–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è –∏ —Å–º–µ–ª–æ –¥–≤–∏–≥–∞–π—Å—è –≤–ø–µ—Ä—ë–¥, –∏ –º—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –Ω–∞—à–∏ –ø—É—Ç–∏ –µ—â—ë –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å–µ–∫—É—Ç—Å—è!""")
                    return
            else:
                # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ evaluated_applications, –∑–Ω–∞—á–∏—Ç –æ–Ω –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª –∑–∞—è–≤–∫—É
                await callback.message.answer("üò¢ –í—Ç–æ—Ä–æ–π —ç—Ç–∞–ø –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
                return
        except Exception:
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø
            pass
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–∏–∞–ª–æ–≥—É —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –∑–∞–¥–∞–Ω–∏—è–º–∏
    await dialog_manager.start(state=TasksSG.main)


async def on_support_clicked(callback: CallbackQuery, button, dialog_manager: DialogManager):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É '–ü–æ–¥–¥–µ—Ä–∂–∫–∞'"""
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–∫–Ω—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    await dialog_manager.switch_to(state=MainMenuSG.support)
